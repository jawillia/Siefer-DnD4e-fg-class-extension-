<?xml version="1.0" encoding="iso-8859-1"?>

<!-- 
  Please see the license.html file included with this distribution for 
  attribution and copyright information.
-->

<root>
  <windowclass name="reference_class" copy="record_window_tabbed">
    <tab>
      <name>main</name>
      <resource>tab_main</resource>
      <class>reference_class_description</class>
      <embed />
    </tab>
    <tab merge="add">
      <name>features</name>
      <resource>tab_features</resource>
      <class>reference_class_features</class>
      <embed />
    </tab>
    <tab merge="add">
      <name>other</name>
      <resource>tab_traits</resource>
      <class>reference_class_traits</class>
      <embed />
    </tab>    
  </windowclass>

  <windowclass name="reference_class_header" copy="record_header" />

  <windowclass name="reference_class_description">
    <script>
      function onInit()
        update();
      end
      
      function update()
        local bReadOnly = WindowManager.getReadOnlyState(getDatabaseNode());
        flavor.update(bReadOnly);

        WindowManager.callSafeControlUpdate(self, "shortdescription", bReadOnly);
        WindowManager.callSafeControlUpdate(self, "description", bReadOnly);
      end
      function onDrop(x, y, draginfo)
        if WindowManager.getReadOnlyState(getDatabaseNode()) then
          return true;
        end
        if draginfo.isType("shortcut") then
          local sClass = draginfo.getShortcutData();
          local nodeSource = draginfo.getDatabaseNode();
          
          if sClass == "reference_racialtrait" or sClass == "reference_subracialtrait" then
            self.addTrait(DB.getValue(nodeSource, "name", ""), DB.getText(nodeSource, "text", ""));
          end
          return true;
        end
      end
      function addTrait(sName, sText)
        local nodeTrait = DB.createChild(DB.getPath(getDatabaseNode(), "traits"));
        if nodeTrait then
          DB.setValue(nodeTrait, "name", "string", sName);
          DB.setValue(nodeTrait, "text", "formattedtext", sText);
        end
      end
    </script>
    <sheetdata>
      <anchor_column name="columnanchor" />
      
      <stringc_column_flavor name="flavor" />

      <header_column name="shortdescription_label">
        <static textres="power_header_shortdescription" />
      </header_column>
      <string_columnh_full name="shortdescription" />
      
      <header_column name="description_label">
        <static textres="power_header_description" />
      </header_column>
      <ft_columnh name="description" />      
    </sheetdata>
  </windowclass>  

  <windowclass name="reference_class_features">
    <margins control="0,0,0,5" />
    <script>
      function onInit()
        self.onLockModeChanged(WindowManager.getWindowReadOnlyState(self));
      end
      function onLockModeChanged(bReadOnly)
        local tControls = { "features_iadd", "featurechoices_iadd", };
        WindowManager.callSafeControlsSetLockMode(self, tControls, bReadOnly);
      end
      function onDrop(x, y, draginfo)
        if draginfo.isType("shortcut") then
          local sClass,sRecord = draginfo.getShortcutData();
          if sClass == "reference_classfeature" then
            local bReadOnly = WindowManager.getReadOnlyState(getDatabaseNode());
            if not bReadOnly then
              local w = features.createWindow();
              if w then
                local node = w.getDatabaseNode();
                DB.setValue(node, "name", "string", DB.getValue(DB.getPath(sRecord, "name"), 0));
                DB.setValue(node, "level", "number", DB.getValue(DB.getPath(sRecord, "level"), 0));
                DB.setValue(node, "text", "formattedtext", DB.getValue(DB.getPath(sRecord, "text"), ""));
              end
              return true;
            end
          elseif sClass == "reference_classfeaturechoice" then
            local bReadOnly = WindowManager.getReadOnlyState(getDatabaseNode());
            if not bReadOnly then
              local w = featurechoices.createWindow();
              if w then
                local node = w.getDatabaseNode();
                DB.setValue(node, "name", "string", DB.getValue(DB.getPath(sRecord, "name"), 0));
                DB.setValue(node, "level", "number", DB.getValue(DB.getPath(sRecord, "level"), ""));
                DB.setValue(node, "text", "formattedtext", DB.getValue(DB.getPath(sRecord, "text"), ""));
                DB.setValue(node, "choicetype", "string", DB.getValue(DB.getPath(sRecord, "choicetype"), ""));
                DB.setValue(node, "prerequisite", "string", DB.getValue(DB.getPath(sRecord, "prerequisite"), ""));
              end
              return true;
            end
          end
        end
      end
    </script>
    <sheetdata>
      <anchor_content_top />

      <header_content_framed_headersimple name="features_header">
        <static textres="class_header_features"/>
      </header_content_framed_headersimple>
      <button_iadd name="features_iadd">
        <anchored to="features_header" position="insidetopright" offset="2,0" />
        <target>features</target>
      </button_iadd>
      <list_content_column name="features">
        <datasource>.features</datasource>
        <class>reference_classfeature_listitem</class>
        <sortby><field>level</field><field>name</field></sortby>
      </list_content_column>

      <header_content_framed_headersimple name="featurechoices_header">
        <static textres="class_header_featurechoices"/>
      </header_content_framed_headersimple>
      <button_iadd name="featurechoices_iadd">
        <anchored to="featurechoices_header" position="insidetopright" offset="2,0" />
        <target>featurechoices</target>
      </button_iadd>
      <list_content_column name="featurechoices">
        <datasource>.featurechoices</datasource>
        <class>reference_classfeaturechoice_listitem</class>
        <sortby><field>choicetype</field><field>level</field><field>name</field></sortby>
      </list_content_column>
    </sheetdata>
  </windowclass>
  <windowclass name="reference_classfeature_listitem">
    <margins control="0,0,0,2" />
    <script>
      function onInit()
        self.onLockModeChanged(WindowManager.getWindowReadOnlyState(self));
      end
      function onLockModeChanged(bReadOnly)
        local tControls = { "level", "name", "idelete", };
        WindowManager.callSafeControlsSetLockMode(self, tControls, bReadOnly);
      end
    </script>
    <sheetdata>
      <anchor_listitem_left_sm name="leftanchor" />
      <anchor_listitem_right_sm name="rightanchor" />

      <button_listitem_idelete_left name="idelete" />
      <linkc_listitem_left name="shortcut">
        <class>reference_classfeature</class>
      </linkc_listitem_left>
      <number_listitem_left name="level">
        <nodrag />
      </number_listitem_left>

      <string_listitem_center name="name">
        <empty textres="library_recordtype_empty_classfeature" />
        <font>sheetlabel</font>
      </string_listitem_center>
    </sheetdata>
  </windowclass>
  <windowclass name="reference_classfeaturechoice_listitem">
    <margins control="0,0,0,2" />
    <script>
      function onInit()
        self.onLockModeChanged(WindowManager.getWindowReadOnlyState(self));
      end
      function onLockModeChanged(bReadOnly)
        local tControls = { "choicetype", "level", "name", "idelete", };
        WindowManager.callSafeControlsSetLockMode(self, tControls, bReadOnly);
      end
    </script>
    <sheetdata>
      <anchor_listitem_left_sm name="leftanchor" />
      <anchor_listitem_right_sm name="rightanchor" />

      <button_listitem_idelete_left name="idelete" />
      <linkc_listitem_left name="shortcut">
        <class>reference_classfeaturechoice</class>
      </linkc_listitem_left>
      <string_listitem_left name="choicetype">
        <anchored width="180" />
        <font>sheetlabel</font>
        <empty textres="classfeaturechoice_empty_choicetype" />
      </string_listitem_left>
      <number_listitem_left name="level">
        <nodrag />
      </number_listitem_left>

      <string_listitem_center name="name">
        <empty textres="library_recordtype_empty_classfeaturechoice" />
        <font>sheetlabel</font>
      </string_listitem_center>
    </sheetdata>
  </windowclass>

  <windowclass name="reference_class_traits">
    <margins control="0,0,0,5" />
    <script>
      function onInit()
        self.onLockModeChanged(WindowManager.getWindowReadOnlyState(self));
        local node = getDatabaseNode();
        self.updateClassFieldsFromDescription(node);
      end
      function onLockModeChanged(bReadOnly)
        local tFields = { "role", "powersource", "keyabilities", "armorproficiencies", "weaponproficiencies", "defensebonus", "hitpointsfirstlevel", "hpPerLevel", "healingsurges", "trainedskills", };
        WindowManager.callSafeControlsSetLockMode(self, tFields, bReadOnly);
      end

      function updateClassFieldsFromDescription(nodeRecord)
        local sDescriptionText = DB.getValue(nodeRecord, "description", "");
        if sDescriptionText then
          if not DB.getPath(nodeRecord, "role") or not DB.getValue(nodeRecord, "role") or DB.getValue(nodeRecord, "role") == "" then
            Debug.console("role not found.");
            local sRoleDescriptionTextLine = string.match(sDescriptionText, "&lt;p&gt;%s*&lt;b&gt;%s*Role%s*:%s*&lt;/b&gt;%s*(.-)&lt;/p&gt;");
            Debug.console("sRoleDescriptionTextLine", sRoleDescriptionTextLine);
            if sRoleDescriptionTextLine then
              DB.setValue(node, "role", "string", sRoleDescriptionTextLine);
            end
          else
            Debug.console("role found", DB.getValue(nodeRecord, "role"));
          end
        end
      end
    </script>
    <sheetdata>
      <anchor_content_top />

      <label_content_column name="role_label">
        <static textres="class_label_role" />
      </label_content_column>
      <string_content_columnh name="role" />

      <label_content_column name="powersource_label">
        <static textres="class_label_powersource" />
      </label_content_column>
      <string_content_columnh name="powersource" />

      <label_content_column name="keyabilities_label">
        <static textres="class_label_keyabilities" />
      </label_content_column>
      <string_content_columnh name="keyabilities" />      

      <header_content_framed_headersimple name="proficiencies_header">
        <static textres="class_header_proficiencies"/>
      </header_content_framed_headersimple>
      <label_content_column name="armorproficiencies_label">
        <static textres="class_label_armorproficiencies" />
        <tooltip textres="class_tooltip_armorproficiencies" />
      </label_content_column>
      <string_content_columnh name="armorproficiencies" source="armorproficiencies" />
      <label_content_column name="weaponproficiencies_label">
        <static textres="class_label_weaponproficiencies" />
        <tooltip textres="class_tooltip_weaponproficiencies" />
      </label_content_column>
      <string_content_columnh name="weaponproficiencies" source="weaponproficiencies" />
      <label_content_column name="defensebonus_label">
        <static textres="class_label_defensebonuses" />
        <tooltip textres="class_tooltip_defensebonuses" />
      </label_content_column>
      <string_content_columnh name="defensebonus" source="defensebonus" />      
      <label_content_column name="hitpointsfirstlevel_label">
        <static textres="class_label_hitpointsfirstlevel" />
        <tooltip textres="class_tooltip_weaponproficiencies" />
      </label_content_column>
      <string_content_columnh name="hitpointsfirstlevel" source="hitpointsfirstlevel" />
      <label_content_column name="hitpointsperlevel_label">
        <static textres="class_label_hitpointsperlevel" />
        <tooltip textres="class_tooltip_hitpointsfirstlevel" />
      </label_content_column>
      <number_content_columnh name="hpPerLevel" source="hitpointsperlevel" />
      <label_content_column name="healingsurges_label">
        <static textres="class_label_healingsurgesperday" />
        <tooltip textres="class_tooltip_healingsurgesperday" />
      </label_content_column>
      <string_content_columnh name="healingsurges" source="healingsurges" />
      <label_content_column name="trainedskills_label">
        <static textres="class_label_trainedskills" />
      </label_content_column>
      <string_content_columnh name="trainedskills" source="trainedskills" />

      <header_content_framed_headersimple name="classSkillList_header">
        <static textres="class_header_classskilllist"/>
      </header_content_framed_headersimple>
      <button_iadd name="classSkillList_iadd">
        <anchored to="classSkillList_header" position="insidetopright" offset="2,0" />
        <target>classSkillList</target>
      </button_iadd>
      <list_content_column name="classSkillList">
        <datasource>.skilllist</datasource>
        <class>reference_classSkill_listitem</class>
        <sortby><field>label</field></sortby>
      </list_content_column>      
    </sheetdata>
  </windowclass>

  <windowclass name="reference_classSkill_listitem">
    <margins control="0,0,0,2" />
    <script>
      function onInit()
        self.onLockModeChanged(WindowManager.getWindowReadOnlyState(self));
      end
      function onLockModeChanged(bReadOnly)
        local tControls = { "name", "statname", "idelete", };
        WindowManager.callSafeControlsSetLockMode(self, tControls, bReadOnly);
      end
    </script>
    <sheetdata>
      <anchor_listitem_left_sm name="leftanchor" />
      <anchor_listitem_right_sm name="rightanchor" />

      <button_listitem_idelete_left name="idelete" />
<!--       <linkc_listitem_left name="shortcut">
        <class>reference_classfeature</class>
      </linkc_listitem_left> -->

      <string_listitem_center name="name">
        <empty textres="library_recordtype_empty_classSkill" />
        <font>sheetlabel</font>
      </string_listitem_center>

      <string_listitem_right name="statname">
        <font>sheetlabel</font>
      </string_listitem_right>
    </sheetdata>
  </windowclass>  

  <windowclass name="reference_classfeature" copy="record_window">
    <script>
      function onInit()
        super.onInit();

        local node = getDatabaseNode();
        local nodeContainerRecord = DB.getChild(node, "...");
        local sRecordType = LibraryData.getRecordTypeFromRecordPath(DB.getPath(nodeContainerRecord));
        if sRecordType == "class" then
          content.setValue("reference_classfeature_stats", getDatabaseNode());
        end
      end
    </script>
  </windowclass>
  <windowclass name="reference_classfeature_header" copy="record_header">
    <name_emptyres>library_recordtype_empty_classfeature</name_emptyres>
  </windowclass>
  <windowclass name="reference_classfeature_stats">
    <margins control="0,0,0,5" />
    <script>
      function onInit()
        self.onLockModeChanged(WindowManager.getWindowReadOnlyState(self));
      end
      function onLockModeChanged(bReadOnly)
        local tFields = { "level", "text", };
        WindowManager.callSafeControlsSetLockMode(self, tFields, bReadOnly);
      end
    </script>
    <sheetdata>
      <anchor_content_top />

      <label_content_column name="level_label">
        <static textres="level" />
      </label_content_column>
      <number_content_column name="level">
        <nodrag />
      </number_content_column>

      <ft_content_column_full name="text" />

      <header_content_framed_headersimple name="powerslist_header">
        <static textres="class_header_featurepowers"/>
      </header_content_framed_headersimple>
      <button_iedit name="powerslist_iedit">
        <anchored to="powerslist_header" position="insidetopright" offset="5,0" />
        <edittarget>powerslist</edittarget>
      </button_iedit>
      <button_iadd name="powerslist_iadd">
        <anchored to="powerslist_header" position="insidetopright" offset="30,0" />
        <target>powerslist</target>
      </button_iadd>
      <list_content_column name="powerslist">
        <datasource>.powers</datasource>
        <class>reference_classpower_listitem</class>
        <sortby><field>name</field></sortby>
      </list_content_column>

      <header_content_framed_headersimple name="powerchoiceslist_header">
        <static textres="class_header_featurepowerschoice"/>
      </header_content_framed_headersimple>
      <button_iedit name="powerschoicelist_iedit">
        <anchored to="powerchoiceslist_header" position="insidetopright" offset="5,0" />
        <edittarget>powerschoicelist</edittarget>
      </button_iedit>
      <button_iadd name="powerschoicelist_iadd">
        <anchored to="powerchoiceslist_header" position="insidetopright" offset="30,0" />
        <target>powerschoicelist</target>
      </button_iadd>
      <list_content_column name="powerschoicelist">
        <datasource>.powers</datasource>
        <class>reference_classpower_listitem</class>
        <sortby><field>name</field></sortby>
      </list_content_column>       
    </sheetdata>
  </windowclass>

  <windowclass name="reference_classpower_listitem">
    <margins control="0,0,0,2" />
    <script>
      function update(bReadOnly)
        WindowManager.callSafeControlUpdate(self, "name", bReadOnly);
      end
    </script>
    <sheetdata>
      <anchor_listitem_left_sm name="leftanchor" />
      <anchor_listitem_right_sm name="rightanchor" />

      <linkc_listitem_right name="shortcut">
        <class>powerdesc</class>
      </linkc_listitem_right>
      <button_listitem_idelete name="idelete">
        <editmode>powerslist_iedit</editmode>
      </button_listitem_idelete>

      <string_listitem_center name="name">
        <empty textres="library_recordtype_empty_classfeaturepower" />
        <font>sheetlabel</font>
      </string_listitem_center>
    </sheetdata>
  </windowclass>   
</root>